<!DOCTYPE html>
<html>
<head>
    <title>PrintRallyCards</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.printcards.PrintCard",{extend:"Ext.Component",alias:"widget.printcard",tpl:Ext.create("Ext.XTemplate",'<tpl><div class="artifact"><div class="card-header"><span class="formattedid {[this.getCardType(values)]}">{FormattedID}{[this.getParentID(values)]}</span><span class="owner">{[this.getOwnerImage(values)]}</span><span class="ownerText">{[this.getOwnerName(values)]}</span></div><div class="content"><div class="name">{Name}</div><div class="description">{Description}</div></div><span class="planestimate">{[this.getEstimate(values)]}</span></div></tpl>',{getOwnerImage:function(values){return""},getOwnerName:function(values){return values.storyTeam},getParentID:function(values){return values.WorkProduct&&":"+values.WorkProduct.FormattedID||""},getEstimate:function(values){return values.Estimate||values.PlanEstimate||"None"},getCardType:function(values){return values.FormattedID.startsWith("DE")?"defect":"story"}})})}();
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",requires:["Rally.data.wsapi.Store","Rally.apps.printcards.PrintCard","Rally.app.plugin.Print"],plugins:[{ptype:"rallyappprinting"}],scopeType:"iteration",autoScroll:!0,launch:function(){this.add({xtype:"container",itemId:"cards"}),this.callParent(arguments)},onScopeChange:function(scope){this.down("#cards").getEl().setHTML(""),this._loadStories(scope)},_loadStories:function(scope){Ext.create("Rally.data.wsapi.artifact.Store",{context:this.getContext().getDataContext(),autoLoad:!0,models:["User Story","Defect"],fetch:["FormattedID","Name","Owner","Description","PlanEstimate","Tasks"],limit:scope.getRecord()?200:50,listeners:{load:this._doMore,scope:this},filters:[scope.getQueryFilter()]})},_doMore:function(store,records){_.each(records,function(record,idx){record.getCollection("Tasks").load({fetch:["FormattedID","Name","State","Owner"],callback:function(taskRecords,operation,success){var names=Ext.Array.map(taskRecords,function(task){return task.get("Owner")._refObjectName},this),unique=Ext.Array.unique(names),sorted=Ext.Array.sort(unique),storyTeam="";Ext.Array.each(sorted,function(value){storyTeam+=storyTeam?", "+value:value}),record.data.storyTeam=storyTeam},scope:this})},this),setTimeout(function(target,myStore,myRecords){target._onStoriesLoaded(myStore,myRecords)},3e3,this,store,records)},_onStoriesLoaded:function(store,records){var printCardHtml="";_.each(records,function(record,idx){printCardHtml+=Ext.create("Rally.apps.printcards.PrintCard").tpl.apply(record.data),idx%4===3&&(printCardHtml+='<div class="pb"></div>')},this),Ext.DomHelper.insertHtml("beforeEnd",this.down("#cards").getEl().dom,printCardHtml),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)},getOptions:function(){return[this.getPrintMenuOption({title:"Print Rally Cards App"})]}});

            Rally.launchApp('CustomApp', {
                name:"PrintRallyCards",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app{margin:5px;width:100%;height:100%}.app html{background-color:#fff;color:#000;font:14pt / 1.26;margin:0;padding:0}.app .header{margin:5px}.app .description{float:left;font:12pt NotoSans, Helvetica, Arial;margin:0.25em auto 0 auto;padding-left:1.0em;padding-right:1.0em;overflow-y:hidden;width:100%;word-wrap:break-word}.app .card-header{border:1px;border-bottom-style:solid;display:table-cell;height:40px;vertical-align:middle;width:4.6in}.app .name{font:28px ProximaNovaBold, Helvetica, Arial;padding-top:0.5em;text-align:center}.app .owner{float:right;height:40px}.app .ownerText{float:right;font:14pt / 1.26 NotoSans,Helvetica,Arial;margin-right:0.3em;margin-top:0.3em}.app .formattedid{float:left;font:48pt NotoSans, Helvetica, Arial;margin-left:0.25em;margin-top:0.3em;font-weight:bold}.app .story{color:black}.app .defect{color:red}.app .planestimate{bottom:0.5em;position:absolute;right:0.5em}.app .content{height:2.4in;overflow:hidden;width:4.6in;color:black;padding-left:4px;padding-right:8px}.app body{background-color:#fff;margin:0;padding:0}.app .cb{clear:both}.app .artifact{background-color:#fff;border:2px solid #000;float:left;height:3.2in;margin:0.1in 0.1in 0.1in 0.1in;position:relative;overflow:hidden;width:4.6in}.print-page .app{width:1000px !important;height:100% !important;overflow:hidden !important}.print-page .app .header{display:none}@media print{.app .pb{page-break-after:always;clear:both}}
    </style>
</head>
<body>
</body>
</html>
